---
title: "Monitoramento de Frota de Ônibus"
date: 2025-11-11
image: frota.jpg
description: "Mapa interativo com paradas e posições em tempo real de ônibus."
categories: [Python, API, Mapas]
---

## Resumo

O objetivo desta atividade foi construir um **mapa interativo** com as **paradas de uma linha de ônibus** e as **posições em tempo real dos veículos**.  
A aplicação consulta a **API Olho Vivo (SPTrans)**, utiliza um **token de autenticação** e exibe no mapa duas camadas:  
- **Paradas (pinos azuis)**  
- **Ônibus em tempo real (pinos vermelhos)**  

O resultado final é um mapa dinâmico que facilita visualizar a operação da linha.

---

## Objetivo

Representar no mapa tanto as paradas fixas quanto os ônibus em movimento de uma linha específica.

---

## Como pensei (explicação curta)

Comecei carregando o token do arquivo `.env` e autenticando na API usando `requests.Session`, pois essa API exige manter a sessão válida após o login.  
Em seguida busquei a linha pelo nome (“875A”), já que a API retorna o **código interno da linha**, que é necessário para consultar paradas e posições.

Com o código e o sentido retornados, fiz a requisição das paradas e utilizei suas coordenadas para criar um mapa com o **Folium**, adicionando um pino azul para cada parada.  
Depois consultei o endpoint de posição e, se houvesse ônibus circulando, adicionei pinos vermelhos mostrando o veículo e sua localização atual.

Por fim salvei tudo em um arquivo HTML, permitindo visualizar paradas + frota em tempo real diretamente no navegador.

---

## Código em Python

O código completo [aqui](frota_onibus.py).  
Rota gerada no mapa: [mapa_frota_875A-10](mapa_frota_875A-10.html).

---

## Código em Python

```{python}
#| echo: false
#| fig-cap: "Monitoramento de frota de ônibus - Linha 875A-10 - Perdizes ↔ Aeroporto de Congonhas (via Av. Washington Luiz, Av. Jabaquara) "

    import os
    import requests
    import folium
    from dotenv import load_dotenv

    load_dotenv(".env")
    TOKEN = os.getenv("SPTRANS_TOKEN")

    s = requests.Session()
    auth = s.post(f"http://api.olhovivo.sptrans.com.br/v2.1/Login/Autenticar?token={TOKEN}")

    if auth.text.lower() != "true":
        print("Falha na autenticação com o token SPTrans.")
        exit()

    linha_nome = "875A"
    url_linhas = f"http://api.olhovivo.sptrans.com.br/v2.1/Linha/Buscar?termosBusca={linha_nome}"
    res_linhas = s.get(url_linhas)
    linhas = res_linhas.json()

    if not linhas:
        print("Nenhuma linha encontrada.")
        exit()

    # Exibe as direções disponíveis
    for i, l in enumerate(linhas, start=1):
        sentido = "Ida" if l["sl"] == 1 else "Volta"
        print(f"{i}. {l['lt']} - {l['tp']} → {l['ts']} ({sentido}) | Código: {l['cl']}")

    # Usa a primeira linha retornada
    linha = linhas[0]
    codigo_linha = linha["cl"]
    sentido = linha["sl"]

    print(f"\nLinha selecionada: {linha['lt']} - {linha['tp']} → {linha['ts']} ({'Ida' if sentido == 1 else 'Volta'})")

    # Buscar paradas da linha
    url_paradas = f"http://api.olhovivo.sptrans.com.br/v2.1/Parada/BuscarParadasPorLinha?codigoLinha={codigo_linha}&sentido={sentido}"
    res_paradas = s.get(url_paradas)
    paradas = res_paradas.json()

    if not paradas:
        print("Nenhuma parada encontrada para esta linha e sentido.")
        exit()

    # Criação do mapa
    mapa = folium.Map(location=[paradas[0]["py"], paradas[0]["px"]], zoom_start=13)

    # Pinos azuis = paradas
    for parada in paradas:
        folium.Marker(
            [parada["py"], parada["px"]],
            popup=parada["np"],
            icon=folium.Icon(color="blue", icon="bus", prefix="fa")
        ).add_to(mapa)

    # Posições em tempo real
    url_posicoes = f"http://api.olhovivo.sptrans.com.br/v2.1/Posicao?codigoLinha={codigo_linha}"
    res_posicoes = s.get(url_posicoes)
    dados_posicao = res_posicoes.json()

    veiculos = []
    if dados_posicao and "vs" in dados_posicao:
        veiculos = dados_posicao["vs"]

    # Pinos vermelhos = ônibus
    if veiculos:
        for v in veiculos:
            folium.Marker(
                [v["py"], v["px"]],
                popup=f"Ônibus {v['p']}",
                icon=folium.Icon(color="red", icon="location-dot", prefix="fa")
            ).add_to(mapa)
    else:
        print("Nenhum ônibus encontrado em tempo real no momento.")

    # Linha 875A-10 - Perdizes ↔ Aeroporto de Congonhas (via Av. Washington Luiz, Av. Jabaquara) 
    mapa.save("mapa_frota_875A-10.html")
    print("Pinos azuis = paradas | Pinos vermelhos = ônibus em tempo real")
